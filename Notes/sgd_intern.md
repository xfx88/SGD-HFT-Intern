<font face=''>

<div align=center>

## 盛冠达实习日志
</div>

> Background is cheap, show me the alpha.
> Talk is cheap, show me the code.
> Create alpha, and be an alpha.

---
<div align=center>

### QuantLab、Sunnytrader
</div>


**回测系统介绍**
sunnytrader是由黄灿老板开发的交易系统，quantlab是由启能达和盛冠达IT部门合作开发的平台，在sunnytrader的基础上进一步的开发和迭代成完善的回测系统，目标是对标卡方面向全市场，提供类似的金融回测服务平台，做成产品化。底层接口是C#编写，回测速度很高，同时可以自己调节策略参数细节，提供每日交易的详细持仓，实时反馈的可视化曲线，各类评价指标，还有对回测结果的归因处理。总体功能完善，并且可以直接对接实盘下单。目前盛冠达的IT和量化开发做的就是这些东西，quantlab会不停的迭代，而且似乎还每隔一个月就要更新，整体版本不断升级迭代，去年到今年就已经从quantlab2升级到了quantlab3，功能越来越完善，目前做的最好的交易算法，TWAP和VWAP已经非常完善，还有T0算法（T0交易下单是盛冠达的招牌）。建议仔细研读文档，研读样例，尤其是交易下单T0的部分，这是sgd的头牌算法，同时在`sgd_share`里面由T0 project，宝藏这么多，一定要好好学啊，顺便温习下C++和C#，这样过后就指导量化开发工程师是在干什么的了。



#### 数据系统

**回测平台架构**
目前实现的更新：包括升级到.NET5.0和sunnytrader同步，实现跨语言跨平台等等（原先只支持windows下的C#）
- Level 1 基于文件的数据系统（跨平台，跨语言）
- Level 2 (.NET 5.0) 数据API
- Level 3 (.NET 5.0) QUANTLAB

**数据系统**
- 数据类别：
  - 股票：日线、分钟线、Tick级、逐笔成交、逐笔委托
  - 期货：日线、分钟线、Tick级(L1&L2)
- 数据路径：Windows共享: `\\192.168.1.147\sgd-data\data`；Linux NFS: `sudo mount 192.168.1.147:/sgd-data/sgd-data`；用户名：traders；密码：abcd4321，或者另一组用户名sgd，密码sgd123。后面的这组用户名和密码可以访问更多的权限，前面的账户密码只能接触到147服务器的data文件夹，而后面的可以接触其他的文件夹，包括`sgd_share`文件夹，里面应该是有成熟的策略，包括一个corr还有一个T0 strategy的东西，值得仔细研读。数据格式两种，`csv.gz`格式是适合pandas，因为pandas读取csv较快，而csv.gz对csv文件实现进一步的压缩，读取的时候可以使用`pd.read_csv`读取。`pb.gz`格式适合C++或者C#等，protocol buffer格式。
- windows连接公开服务器的方法（注意必须公开，139就不行），直接在文件explorer的根目录，上面输入两个斜杠，`\\192.168.1.147`，输入密码即可访问。每次重启需要重新输入一次，接下来就不用。直接用文件管理器打开打开的是共享的部分，可以看到只能查看sgd_data, sgd_share等文件夹。而如果使用vscode做远程连接，open folder里面退出/home目录，就可以看到这些sgd_data, sgd_share的文件夹，还有其他的一些没有公开的目录。或者直接win+R，然后在弹出框里面输入`\\192.168.1.147`，效果是一样的。
- 目前sgd_data下面的data下面是，future是期货基础数据，future_l2是期货的level2数据，然后有股票的数据，成交数据`stock_order`，还有逐笔数据`stock_trans`，再点开里面，数据是按照每天一个文件夹存储的，里面有`candle_csv/candle_pb`分钟线数据，`daily_csv/pb`日线数据，`tick_csv/pb`是tick数据，每一个文件夹下面是全体A股的`.csv.gz`或者`.pb.gz`的合集。其他的DataGen文件我盲猜是让这个服务器能实时获取数据并进行记录的工具。
- 毫无疑问我们要访问147服务器需要连接公司的网络。我们在`RemoteQuery`里面是从147把数据拿到了139里面放到了一个缓存的路径，目的是减少网络通讯。如果不在我们指定的缓存路径`backtest_temp`下，我们就会直接读取。直接读取csv.gz和直接读csv的方式一模一样，唯一不同就是服务器路径前面是两个斜杠，即`data = pd.read_csv(r"\\192.168.1.147\sgd-data\data\stock\20120104\tick_csv\000001.SSE.csv.gz")`即可。csv.gz极其好用，能把原来的csv压缩到接近十分之一的大小，比较好用的就是格式就是csv.gz, parquet, pkl, h5等。

- 要存储的是一整个公司都要使用的数据系统，经过各种测试，这种系统的存储方式的速度是最快的。我们试过各种各样的database，但是要大量读取这种，一整天一整天的tick数据，一定是系统最快。第二是方便管理，非常清晰的可视化，如果是数据库就不方便查看。黄总直接质疑数据是哪的，说是从数据库转换来的，数据库底层是购买的吗？不是，是我们自己录的，黄总直接说经常反应这个录的数据交易质量不高。期货数据下午收盘录入一次，夜盘结束录一次。股票当天的数据四点多会录入，五六点就会录入数据库。

- 目前数据开盘前的集合竞价是有的，还有些有下午三点过后的数据，上午收盘和下午收盘的K线可能都会多那么一两根，因为交易所，比如收盘后会比较数据，会再推送一点数据，自己做策略的时候上午收盘和下午收盘做一个过滤。


#### 回测系统

**环境配置**
- 安装vs2019或者vs2022（vs2022不用配置一些可执行文件），安装.NET CORE 5.0，然后尽量把quantlab解压到D盘根目录下，防止后续调整路径。回测系统的文件夹下可以解压系统讲解的PPT，doc文档，还有压缩包，解压如果需要密码就使用sgd和sgd123。

**策略编写**
三个步骤：建立项目、添加引用、配置调试
- 建立项目：打开visual studio，语言选择C#，选择下面的类库，然后项目命名，文件夹位置放在`MyStrategy`的统一目录下，仍然建议`MyStrategy`设置为根目录，然后选择把解决方案和项目放在同一目录下(也就是place solution and project in the same directory)，之前我没有勾选过这个选项，不勾选就会让`.sln`文件的目录比和项目同名的project文件夹高一级目录，这样方便查找到solution文件打开project，如果勾选的话，solution文件会放到和project一个目录下，由于里面有很多其他的文件，包括主程序cs文件，还有`.csproj`文件等等，虽然乱，但是这样的好处是能让我们的不同策略集中到一个大的父目录下面，方便管理。接下来选择.NET5框架创建。
- 添加引用：右键项目，然后找到添加，然后找到项目引用。然后点击浏览，就可以直接拖拽需要的六个dll文件。


**sunnytrader界面**
- 多线程还是多进程？python只有多进程，因为python强制了不同进程只能在一个线程里面实行。C#，C++这些是多线程，运行界面的指定数目就是多线程，C#多线程效率极高，不像python是需要去设置的。



**tick策略编写**

- 日内tick策略收盘一定会平仓，所以sunnytrader上面的每日的持仓明细是空的，但每日的成交明细是很多条数据的。股票T0策略也是在持有底仓的情况下开多开空，那么当天结束的时候需要保持原来的底仓不变，所以本质都是一样的。



- IT开发了tick策略的两个数学工具，计算移动平均和移动方差的，MovingAverage和MovingDeviation，原因就是用的最频繁，而且如果是python，每个tick过来都要接收行情计算这些指标的话，速度会很慢，rolling极其慢，原因就是每个行情过来都要重新计算，基本和一个for循环没区别。pandas已经尽可能的优化了，里面的ewma等函数都是调用的C的接口。而使用C#、C++实盘的最大原因，一个是下单的速度得到保证，另一个最重要的就是接收到行情推送的时候的因子计算可以非常迅速。之前在CTA的框架里面涉及到大量的滑动平均的因子计算，这里回测框架的实现，一方面利用了C#的速度，另一方面就是根据每日的数据实时推送的机制，去构造了一个队列，每次行情push过来就推进队列，FIFO机制实现，这样计算一些移动指标就极其之快。**这种行情推送的机制才是真正回测的核心，确保没有使用未来数据，这样的实时推送回测也是与实盘保持一致的最佳方式**。之前的那种HY互相关衡量leadlag的公式，本身也可以写成推送的形式，根据每时每刻的推送，去更新迭代互相关函数的分子分母，这就实现了实盘和回测一致的部署。**这样的循环队列可以有效避免重复计算，使得滑动相关的因子计算达到O(1)的复杂度**。


**日线策略**
- 订阅分钟线数据的时候，原始数据只有1min的，订阅其他任意分钟的K线都会由程序自动合成。min的K线数据是通过tick数据合成的，但是黄总说会有一个问题，就是会不准，比如不小心下错单，把价格打的很高，然后又掉下来了，那这个时候tick的行情是拿不到这个信息的，所以使用tick的数据合成会失去这部分信息，然而那分钟的最高价会很高。有需要的话需要自己录一个分钟数据，而不是从tick合成。有个人一直问为什么没有pre_close字段，笑死，分钟线根本不存在复权这个问题啊，分钟线就是直接get过来的，日线的pre_close字段是做过复权的。


**价格撮合机制**
- 系统默认是你指定什么价格马上按照对应价格成交。可以自己定义撮合，股票tick目前可以实现精细的盘口撮合，但多数策略是不需要的，自己指定一个滑点就行了，尤其是中低频的策略。整体大家需求不一样，而且很复杂，索性让大家自己定义。
- 盘口的撮合，已经是足够的精确的回测机制了，我们能够说你设计T0策略尽量保证做好拆单算法，不要有太多的盘口延迟，这一块需要策略本身有一定的robustness稳健性存在。我们只能说在你每回下单的时候根据盘口的具体情况去回测撮合，去根据卖价盘口下单，但是更精确来讲，你的这次下单会影响当前的盘口，这在我们实盘的时候继续推送盘口数据可以捕捉到这一点，但是在回测的时候是不行的，也就是回测的时候我们默认你这个tick的下单对盘口的影响忽略，也就是不会影响到下一个tick，否则你每次下单后续的盘口回测tick数据全都要更改，这个太复杂了。至于其他的像涨跌停不能买这种，那就是策略层面的事情了。


**提高性能的建议**
- OnDataArrive是在每次tick数据推送的时候进行的操作，因此要极力避免耗时的操作以及重复的操作，比如读取文件、读取数据库、访问网络、尤其要避免for循环。读取数据尽量在beforeTrading就读进来，循环尽量避免，访问网络会造成额外的网络通讯。高频策略对每分每秒的算法都要求极致的快速。
- 自己改进策略的算法复杂度，比如均线算法，尽可能的向量化
- 经常使用的需要读入内存的数据尽量在Init()或者BeforeTrading()中完成预处理
- 能使用K线回测就不要使用tick回测
- 能使用DataUtils读取各种数据就不要在策略里面访问147的数据库，因为会造成额外的网络通讯。建议使用`DataUtils.GetTradingDay()`等函数
- 大的数据结构使用class，不要使用struct，比较耗费时间



---

<div align=center>

### 实习感悟
</div>

**关于传承**

之前实习生开会的时候，万总也一直说到这个问题，很多量化公司不想招实习生，要么就招技术能力很强的来帮忙，要么就自己带策略来。因为公司发现一开始培养人才，手把手教，培养一个量化研究人才往往需要几年的时间，然而这个过程中，是没有绑定的，也就是说没有机制去绑定这些人，因为他们在这个成长的过程中，在变强，但是没有到能发产品的水平，也就是导致成长之后，就会走人。而如果他们有着成熟的策略，公司会给他们一部分的股权奖励，也就是我们说的合伙人的一个机制，这样就能把公司成长和个人的成长绑定起来互相激励。也就是盛冠达之前的这个传承精神做的并不好，员工都没有传承意识，公司培养成人才之后，每天各种猎头来骚扰来诱惑，拿出更高的薪水就跑了。这就缺乏一种发自内心的对公司的感激和对企业文化的认同，从而导致了传承精神的缺失。


现在白鹭到了百亿，看实习生的简章都是要求6个月以上，聚宽也是，诚奇也是，因为这样才能比较完整的培养一个量化人才，三个月的时间实在太短暂了。往往三个月的时间，实习生干不出什么东西，而且在三个月的时间内，很难让一个实习生对整个公司的文化有一个非常深入的体会，那么如果在人才培养的过程当中，没有形成这样的企业文化的认同，那最终人才留存率是很低的，而恰恰量化这个行业是吃经验的，这样就很吃亏。我也希望能去到白鹭实习，我也希望能在那里实习六个月，因为我很喜欢白鹭的企业文化。其实在盛冠达，我签的合同是六个月，现在我基本快干满三个月了，我说实话感觉才刚刚开始入门，刚开始了解公司的回测系统，企业文化，人才的培养逻辑，员工和实习生的身份认同，还有刚刚开始入门深度学习时序预测，开始编写策略。所以我认为大学生的量化实习，那种两三个月的都是扯淡，量化就是搞科研，你搞科研搞了两个月能搞出什么东西？所以很多量化私募要求半年实习，我也非常认同这一点，即使我签的合同是三个月，公司不赶我走的话，我一样会做下去。

当听到最早使用sunnytrader的一批人都走了之后，我才算体会了黄总的心酸。自己写的交易系统，开发成长，结果元老级别的一批人物都走了。这种离职的事情我以后肯定也会遇见，这也是每个创业团队都需要经历的成长吧。

这种内部开发的研究系统，需要开发一个完整的文档出来。公司能把这拿出来给实习生用，已经很感激了，我之前是知道博普的实习生是没资格参加周会的。我们在这里能用到正式员工用的回测框架，用到公司的服务器，已经是万分感激了。盛冠达如今的公司文化我挺认可也感觉十分的舒适，相比于中信证券，我没有看到中信证券有任何的公司文化，垃圾玩意。